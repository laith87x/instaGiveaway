<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Instagram Giveaway Tool</title>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" type="text/css" href="style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


</head>

<body>
    <nav>
        <div class="nav-wrapper">
            <div class="container">
                <a href="#!" class="brand-logo">Insta Picker</a>
                <!-- <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a> -->
                <!-- <ul class="right hide-on-med-and-down">
                    <li><a href="sass.html">Sass</a></li>
                    <li><a href="badges.html">Components</a></li>
                    <li><a href="collapsible.html">Javascript</a></li>
                    <li><a href="mobile.html">Mobile</a></li>
                </ul> -->
            </div>
        </div>
    </nav>

    <!-- <ul class="sidenav" id="mobile-demo"> -->
        <!-- <li><a href="sass.html">Sass</a></li>
        <li><a href="badges.html">Components</a></li>
        <li><a href="collapsible.html">Javascript</a></li>
        <li><a href="mobile.html">Mobile</a></li> -->
    <!-- </ul> -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
            <i class="large material-icons">mode_edit</i>
        </a>
        <ul>
            <li><a class="btn-floating red"><i class="material-icons">insert_chart</i></a></li>
            <li><a class="btn-floating yellow darken-1"><i class="material-icons">format_quote</i></a></li>
            <li><a class="btn-floating green"><i class="material-icons">publish</i></a></li>
            <li><a class="btn-floating blue"><i class="material-icons">attach_file</i></a></li>
        </ul>
    </div>

    <div class="container">
        <div class="row">
            <div class="col s12">
                <h3>Welcome to Insta-picker!</h3>
                <h4>Instagram contests made easy.</h4>
                <ol>
                    <li>Set your profile to public.</li>
                    <li>Copy and paste the URL of the Giveaway post into our tool.</li>
                    <li>We do the rest! Your winner will automatically be picked from the comments!</li>
                </ol>
            </div>
        </div>

        <div class="row" id="submitCard">
            <div class="col s12 m6">
                <div class="card blue-grey darken-1">
                    <div class="card-content white-text">
                        <span class="card-title">Step 1</span>
                        <p>Enter the URL of your instagram post below. Remeber to set your page to public so that we can
                            access the comments!</p>
                    </div>
                    <div class="card-action">
                        <form method="POST" action="/submit-url">
                            <label for="URL">URL</label>
                            <input id="URL" type="text" name="url">
                            <button id="submitBtn" class="btn waves-effect waves-light" type="submit"
                                name="action">Submit
                                <i class="material-icons right">send</i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row hidden center-align" id="loader">
            <h5 id="loadedComments"></h5>
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                
                    <div class="spinner-layer spinner-red">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                
                    <div class="spinner-layer spinner-yellow">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                
                    <div class="spinner-layer spinner-green">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
        </div>


        <div class="row">
            <table id="commentsTable" class="hidden">
                <thead>
                    <tr>
                        <th>Number</th>
                        <th>Username</th>
                    </tr>
                </thead>

                <tbody id="Tablebody">
                </tbody>
            </table>
        </div>
    </div>




</body>

</html>

<script>
    $(document).ready(function () {
        $('.sidenav').sidenav();
        $('.fixed-action-btn').floatingActionButton();
    });

    $('#submitBtn').click(function (event) {
        event.preventDefault();
        var URL = $("#URL").val().trim();
        console.log(URL);
        $.post("/submit-url", {url: URL}, function(data){
            $("#URL").val("");
        });
        checkStatus();
        $("#submitCard").addClass("hidden");
        $("#loader").removeClass("hidden");
    });

    function checkStatus() {
        $.get("/send-comments", (data) => {
            $("#loadedComments").text(("Comments loaded: " + data.comments.length));
            getcomments(data);
        });
    }


    function getcomments(loaded) {
        if (loaded.loading) {
            setTimeout(function () {
                checkStatus();
                console.log("loding");
            }, 3000);
        }
        else {
            console.log(loaded.comments);
            appendComments(loaded.comments);
        }
    };

    function appendComments(data) {
        $("#loader").addClass("hidden");
        $("#commentsTable").removeClass("hidden");
        for (let i in data) {
            num = parseInt(i) + 1;
            let row = $("<tr>");
            row.append(`<td>${num}</td>`);
            row.append(`<td>${data[i].username}</td>`);
            $("#Tablebody").append(row);
        };
        clearTable();
    };

    function clearTable(){
        $.post("/emptyVars", function(){
            console.log("Clearing...");
        });
    };

</script>